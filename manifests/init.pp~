class omd-cluster (
	$nodes = undef,
	$cluster_name = 'acme',
	$cluster_ip = undef,
	$cluster_quorum = "sdb",
	$cluster_uid = "999",
#	$corosync_interfaces = ['eth1','eth2'],
) {
	# network config
	network::if::static { $corosync_1_dev:
		ensure    => 'up',
		ipaddress => $corosync_1_ip,
		netmask   => '255.255.255.0',
	}

	network::if::static { $corosync_2_dev:
		ensure    => 'up',
		ipaddress => $corosync_2_ip,
		netmask   => '255.255.255.0',
	}
	
	yumrepo { "consollabs-omd":
		baseurl => "https://labs.consol.de/repo/stable/rhel6/x86_64",
		descr => "Consol Labs OMD Repo",
		enabled => 1,
		gpgcheck => 0,
	}
	yumrepo { "elrepo":
		baseurl => 'http://elrepo.org/linux/elrepo/el6/$basearch/',
		descr => "elrepo",
		enabled => 1,
		gpgcheck => 0,
	}
	file { "/etc/hosts.local":
		mode => 644,
		owner => root,
		group => root,
		content => template('omd-cluster/hosts.local.erb'),
	}
	exec { "/sbin/pvcreate /dev/$cluster_quorum && /sbin/vgcreate vg_omd_data /dev/$cluster_quorum && /sbin/lvcreate -l 80%VG -n lv_omd_quorum vg_omd_data":
		unless => "/sbin/lvs | /bin/grep lv_omd_quorum"
	}
	package { "drbd83-utils":
		ensure => "installed",
		require => Yumrepo["elrepo"],
		#alias => "drbd-install",
	}
	package { "kmod-drbd83":
		ensure => "installed",
		require => Yumrepo["elrepo"],
		#alias => "drbd-install",
	}
	package { "omd":
		ensure => "installed",
		require => Yumrepo["consollabs-omd"],
	}
	package { "corosync":
		ensure => "installed",
	}
	package { "pacemaker":
		ensure => "installed",
	}
#, 
	exec { "/sbin/modprobe drbd":
		unless => "/sbin/lsmod | /bin/grep drbd",
		require => [ Package["drbd83-utils"], Package["kmod-drbd83"] ],
	}

	class { 'check_mk':
		package	=> 'omd-1.10',
		site => 'acme',
		require	=> Package["omd"],
	}

}
